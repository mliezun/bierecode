# GitHub Actions workflow for building and deploying the site
#
# The workflow performs the following steps:
# 1. Checkout code
# 2. Install Node dependencies and build the static site
# 3. Initialize and apply Terraform to create the KV namespace
# 4. Inject the KV namespace ID into wrangler.toml
# 5. Deploy the built site and functions to Cloudflare Pages
#
# Required repository secrets:
#   CLOUDFLARE_API_TOKEN - API token with Pages and KV permissions
#   CLOUDFLARE_ACCOUNT_ID - Cloudflare account ID
name: Deploy to Cloudflare

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform init
        working-directory: infra
        run: terraform init

      - name: Terraform fmt check
        working-directory: infra
        run: terraform fmt -check

      - name: Terraform apply
        working-directory: infra
        env:
          TF_VAR_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: terraform apply -auto-approve

      - name: Capture KV namespace ID
        working-directory: infra
        shell: bash
        run: |
          KV=$(terraform output -raw kv_namespace_id | tail -n 1)
          echo "KV_ID=$KV" >> "$GITHUB_ENV"

      - name: Inject KV namespace ID into wrangler.toml
        run: |
          sed -i "s/id = \".*\"/id = \"$KV_ID\"/" wrangler.toml
          sed -i "s/preview_id = \".*\"/preview_id = \"$KV_ID\"/" wrangler.toml

      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler pages deploy ./dist --project-name bierecode-site --branch main
