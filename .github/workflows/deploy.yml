# GitHub Actions workflow for building and deploying the site
#
# The workflow performs the following steps:
# 1. Checkout code
# 2. Install Node dependencies and build the static site
# 3. Initialize and apply Terraform to create the KV namespace
# 4. Inject the KV namespace ID into wrangler.toml
# 5. Deploy the built site and functions to Cloudflare Pages
#
# The workflow runs on pushes to `main` and also whenever a pull request
# targeting `main` is updated. This allows previewing infrastructure and
# site changes before merging.
#
# Required repository secrets:
#   CLOUDFLARE_API_TOKEN - API token with Pages and KV permissions
#   CLOUDFLARE_ACCOUNT_ID - Cloudflare account ID
name: Deploy to Cloudflare

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Load Terraform state from KV
        shell: bash
        env:
          CF_API: https://api.cloudflare.com/client/v4
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          set -e
          NS=$(curl -sf \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            "$CF_API/accounts/$CF_ACCOUNT_ID/storage/kv/namespaces?per_page=100" \
            | jq -r '.result[] | select(.title=="bierecode-updates") | .id')
          if [ -n "$NS" ]; then
            if curl -sf \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              "$CF_API/accounts/$CF_ACCOUNT_ID/storage/kv/namespaces/$NS/values/terraform.tfstate" \
              -o infra/terraform.tfstate; then
              echo "Existing Terraform state downloaded."
              echo "STATE_FOUND=true" >> "$GITHUB_ENV"
            else
              echo "No existing Terraform state found. Starting fresh."
              echo "STATE_FOUND=false" >> "$GITHUB_ENV"
            fi
            echo "TF_STATE_NAMESPACE_ID=$NS" >> "$GITHUB_ENV"
          fi

      - name: Terraform init
        working-directory: infra
        run: terraform init

      - name: Import existing namespace when state is missing
        if: env.STATE_FOUND == 'false' && env.TF_STATE_NAMESPACE_ID != ''
        working-directory: infra
        env:
          TF_VAR_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        # Terraform requires the ID in the form "accountID/namespaceID" when importing
        # resources. We combine the account ID with the detected namespace ID to
        # bring the existing namespace under Terraform management.
        run: terraform import cloudflare_workers_kv_namespace.updates "$TF_VAR_account_id/$TF_STATE_NAMESPACE_ID"

      - name: Terraform fmt check
        working-directory: infra
        run: terraform fmt -check

      - name: Terraform apply
        working-directory: infra
        env:
          TF_VAR_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: terraform apply -auto-approve

      - name: Capture KV namespace ID
        working-directory: infra
        shell: bash
        run: |
          KV=$(terraform output -raw kv_namespace_id | tail -n 1)
          echo "KV_ID=$KV" >> "$GITHUB_ENV"
          echo "TF_STATE_NAMESPACE_ID=$KV" >> "$GITHUB_ENV"

      - name: Inject KV namespace ID into wrangler.toml
        run: |
          sed -i "s/id = \".*\"/id = \"$KV_ID\"/" wrangler.toml
          sed -i "s/preview_id = \".*\"/preview_id = \"$KV_ID\"/" wrangler.toml

      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler pages deploy ./dist --project-name bierecode-site --branch main

      - name: Upload Terraform state to KV
        if: env.TF_STATE_NAMESPACE_ID != ''
        env:
          CF_API: https://api.cloudflare.com/client/v4
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          curl -s -X PUT \
            "$CF_API/accounts/$CF_ACCOUNT_ID/storage/kv/namespaces/$TF_STATE_NAMESPACE_ID/values/terraform.tfstate" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            --data-binary "@infra/terraform.tfstate"
